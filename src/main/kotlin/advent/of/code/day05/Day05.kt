package advent.of.code.day05

import advent.of.code.Error
import advent.of.code.digits
import advent.of.code.replaceAtIndex
import arrow.core.*
import arrow.core.extensions.fx
import java.lang.Integer.max
import java.util.Scanner


fun main() {
    part1()
}

fun part1(): Unit {
    listOf(
        listOf(1002, 4, 3, 4, 33) to listOf(1002, 4, 3, 4, 99)
//        listOf(2, 4, 4, 5, 99, 0) to listOf(2, 4, 4, 5, 99, 9801),
//        listOf(1, 1, 1, 4, 99, 5, 6, 0, 99) to listOf(30, 1, 1, 4, 2, 5, 6, 0, 99)
    ).forEach {
        println("Input: ${it.first}")
        println("Expectation: ${it.second}")
        println("Result: ${executeOperations(it.first) == it.second.right()}")
    }
    println(executeOperations(taskInput))
}

fun executeOperations(input: List<Int>): Either<Error, List<Int>> {
    fun go(index: Int, input: List<Int>): Either<Error, List<Int>> = Either.fx {
//        println(input)
        val (commandTuple) = input.nextFourFrom(index)
//        println(commandTuple)
        val (command) = commandTuple.toOperation(index)
//        println(command)
        when (command) {
            is Halt -> input.right()
            is ExecutableOperation -> go(index + 4, command.executeOn(input).bind())
            is ReadInput -> go(index + 2, command.executeOn(input).bind())
            is WriteOutput -> go(index + 2, command.executeOn(input).bind())
        }.bind()
    }

    return go(0, input)
}

fun WriteOutput.executeOn(input: List<Int>): Either<Error, List<Int>> =
    if (targetPos < input.size) {
        println(input[targetPos])
        input.right()
    } else Error("Not able to execute $this on input: out of range").left()

fun ReadInput.executeOn(input: List<Int>): Either<Error, List<Int>> =
    if (targetPos < input.size)
        input.replaceAtIndex(targetPos, Scanner(System.`in`).nextInt()).right()
    else
        Error("Not able to execute $this on input: out of range").left()

fun ExecutableOperation.executeOn(input: List<Int>): Either<Error, List<Int>> =
    if (max(pos1, pos2, targetPos) < input.size)
        input.replaceAtIndex(targetPos, f(input[pos1], input[pos2])).right()
    else
        Error("Not able to execute $this on input: out of range").left()

fun max(a: Int, b: Int, c: Int) = max(max(a, b), c)

fun CommandTuple<Int>.toOperation(index: Int): Either<Error, Operation> {
    val commandDigits = a.toDigitsWithLeadingZeros()
    val (mode2, mode1, opcode2, opcode1) = commandDigits
    return when {
        opcode1 == 1 && b != null && c != null && d != null -> constructAdd(mode1, b, mode2, c, d, index)
        opcode1 == 2 && b != null && c != null && d != null -> constructMultiply(mode1, b, mode2, c, d, index)
        opcode1 == 3 && b != null -> ReadInput(b).right()
        opcode1 == 4 && b != null -> WriteOutput(if (mode1 == 0) b else index + 1).right()
        opcode1 == 9 && opcode2 == 9 -> Halt.right()
        else -> Error("Not able to construct command from $this").left()
    }
}

// We still gonna use positions for arguments if it's immediate mode, we will use index for this
fun constructExecutableOperation(
    mode1: Int,
    arg1: Int,
    mode2: Int,
    arg2:Int,
    targetPos: Int,
    index: Int,
    constructor: (Int, Int, Int) -> ExecutableOperation
): Either<Error, ExecutableOperation> = Either.fx {
    val (arg1position) = evaluateArgumentPosition(index + 1, mode1, arg1)
    val (arg2position) = evaluateArgumentPosition(index + 2, mode2, arg2)
    constructor(arg1position, arg2position, targetPos)
}

fun constructAdd(mode1: Int, arg1: Int, mode2: Int, arg2:Int, targetPos: Int, index: Int) =
    constructExecutableOperation(mode1, arg1, mode2, arg2, targetPos, index, ::Add)

fun constructMultiply(mode1: Int, arg1: Int, mode2: Int, arg2:Int, targetPos: Int, index: Int) =
    constructExecutableOperation(mode1, arg1, mode2, arg2, targetPos, index, ::Multiply)

fun evaluateArgumentPosition(index: Int, mode: Int, value: Int): Either<Error, Int> =
    when (mode) {
        0 -> value.right()
        1 -> index.right()
        else -> Error("This mode is not supported: $mode").left()
    }

fun Int.toDigitsWithLeadingZeros(): List<Int> {
    val digits = this.digits()
    return List(4 - digits.size) { 0 } + digits
}

fun <T> List<T>.nextFourFrom(index: Int): Either<Error, CommandTuple<T>> =
    if (index < size)
        CommandTuple(
            this[index],
            getOrNull(index + 1),
            getOrNull(index + 2),
            getOrNull(index + 3)
        ).right()
    else Error("Next four is out of range. Index: $index and list $this").left()

sealed class Operation

object Halt : Operation()

sealed class ExecutableOperation(val f: (Int, Int) -> Int) : Operation() {
    abstract val pos1: Int
    abstract val pos2: Int
    abstract val targetPos: Int
}

data class Add(
    override val pos1: Int,
    override val pos2: Int,
    override val targetPos: Int
) : ExecutableOperation(Int::plus)

data class Multiply(
    override val pos1: Int,
    override val pos2: Int,
    override val targetPos: Int
) : ExecutableOperation(Int::times)

data class ReadInput(
    val targetPos: Int
) : Operation()

data class WriteOutput(
    val targetPos: Int
) : Operation()

data class CommandTuple<T>(val a: T, val b: T?, val c: T?, val d: T?)

val taskInput = listOf(
    3,
    225,
    1,
    225,
    6,
    6,
    1100,
    1,
    238,
    225,
    104,
    0,
    1002,
    148,
    28,
    224,
    1001,
    224,
    -672,
    224,
    4,
    224,
    1002,
    223,
    8,
    223,
    101,
    3,
    224,
    224,
    1,
    224,
    223,
    223,
    1102,
    8,
    21,
    225,
    1102,
    13,
    10,
    225,
    1102,
    21,
    10,
    225,
    1102,
    6,
    14,
    225,
    1102,
    94,
    17,
    225,
    1,
    40,
    173,
    224,
    1001,
    224,
    -90,
    224,
    4,
    224,
    102,
    8,
    223,
    223,
    1001,
    224,
    4,
    224,
    1,
    224,
    223,
    223,
    2,
    35,
    44,
    224,
    101,
    -80,
    224,
    224,
    4,
    224,
    102,
    8,
    223,
    223,
    101,
    6,
    224,
    224,
    1,
    223,
    224,
    223,
    1101,
    26,
    94,
    224,
    101,
    -120,
    224,
    224,
    4,
    224,
    102,
    8,
    223,
    223,
    1001,
    224,
    7,
    224,
    1,
    224,
    223,
    223,
    1001,
    52,
    70,
    224,
    101,
    -87,
    224,
    224,
    4,
    224,
    1002,
    223,
    8,
    223,
    1001,
    224,
    2,
    224,
    1,
    223,
    224,
    223,
    1101,
    16,
    92,
    225,
    1101,
    59,
    24,
    225,
    102,
    83,
    48,
    224,
    101,
    -1162,
    224,
    224,
    4,
    224,
    102,
    8,
    223,
    223,
    101,
    4,
    224,
    224,
    1,
    223,
    224,
    223,
    1101,
    80,
    10,
    225,
    101,
    5,
    143,
    224,
    1001,
    224,
    -21,
    224,
    4,
    224,
    1002,
    223,
    8,
    223,
    1001,
    224,
    6,
    224,
    1,
    223,
    224,
    223,
    1102,
    94,
    67,
    224,
    101,
    -6298,
    224,
    224,
    4,
    224,
    102,
    8,
    223,
    223,
    1001,
    224,
    3,
    224,
    1,
    224,
    223,
    223,
    4,
    223,
    99,
    0,
    0,
    0,
    677,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    1105,
    0,
    99999,
    1105,
    227,
    247,
    1105,
    1,
    99999,
    1005,
    227,
    99999,
    1005,
    0,
    256,
    1105,
    1,
    99999,
    1106,
    227,
    99999,
    1106,
    0,
    265,
    1105,
    1,
    99999,
    1006,
    0,
    99999,
    1006,
    227,
    274,
    1105,
    1,
    99999,
    1105,
    1,
    280,
    1105,
    1,
    99999,
    1,
    225,
    225,
    225,
    1101,
    294,
    0,
    0,
    105,
    1,
    0,
    1105,
    1,
    99999,
    1106,
    0,
    300,
    1105,
    1,
    99999,
    1,
    225,
    225,
    225,
    1101,
    314,
    0,
    0,
    106,
    0,
    0,
    1105,
    1,
    99999,
    108,
    677,
    677,
    224,
    102,
    2,
    223,
    223,
    1005,
    224,
    329,
    101,
    1,
    223,
    223,
    1107,
    677,
    226,
    224,
    102,
    2,
    223,
    223,
    1006,
    224,
    344,
    101,
    1,
    223,
    223,
    1107,
    226,
    226,
    224,
    102,
    2,
    223,
    223,
    1006,
    224,
    359,
    101,
    1,
    223,
    223,
    1108,
    677,
    677,
    224,
    102,
    2,
    223,
    223,
    1005,
    224,
    374,
    101,
    1,
    223,
    223,
    8,
    677,
    226,
    224,
    1002,
    223,
    2,
    223,
    1005,
    224,
    389,
    101,
    1,
    223,
    223,
    108,
    226,
    677,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    404,
    1001,
    223,
    1,
    223,
    107,
    677,
    677,
    224,
    102,
    2,
    223,
    223,
    1006,
    224,
    419,
    101,
    1,
    223,
    223,
    1007,
    226,
    226,
    224,
    102,
    2,
    223,
    223,
    1005,
    224,
    434,
    101,
    1,
    223,
    223,
    1007,
    677,
    677,
    224,
    102,
    2,
    223,
    223,
    1005,
    224,
    449,
    1001,
    223,
    1,
    223,
    8,
    677,
    677,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    464,
    101,
    1,
    223,
    223,
    1108,
    677,
    226,
    224,
    1002,
    223,
    2,
    223,
    1005,
    224,
    479,
    101,
    1,
    223,
    223,
    7,
    677,
    226,
    224,
    1002,
    223,
    2,
    223,
    1005,
    224,
    494,
    101,
    1,
    223,
    223,
    1008,
    677,
    677,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    509,
    1001,
    223,
    1,
    223,
    1007,
    226,
    677,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    524,
    1001,
    223,
    1,
    223,
    107,
    226,
    226,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    539,
    1001,
    223,
    1,
    223,
    1107,
    226,
    677,
    224,
    102,
    2,
    223,
    223,
    1005,
    224,
    554,
    101,
    1,
    223,
    223,
    1108,
    226,
    677,
    224,
    102,
    2,
    223,
    223,
    1006,
    224,
    569,
    101,
    1,
    223,
    223,
    108,
    226,
    226,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    584,
    1001,
    223,
    1,
    223,
    7,
    226,
    226,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    599,
    101,
    1,
    223,
    223,
    8,
    226,
    677,
    224,
    102,
    2,
    223,
    223,
    1005,
    224,
    614,
    101,
    1,
    223,
    223,
    7,
    226,
    677,
    224,
    1002,
    223,
    2,
    223,
    1005,
    224,
    629,
    101,
    1,
    223,
    223,
    1008,
    226,
    677,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    644,
    101,
    1,
    223,
    223,
    107,
    226,
    677,
    224,
    1002,
    223,
    2,
    223,
    1005,
    224,
    659,
    1001,
    223,
    1,
    223,
    1008,
    226,
    226,
    224,
    1002,
    223,
    2,
    223,
    1006,
    224,
    674,
    1001,
    223,
    1,
    223,
    4,
    223,
    99,
    226
)